{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Inbox{% endblock %}</h1>
{% endblock %}

{% block content %}
  {% for conversation in conversations %}
    <article class="convo">
      <br>
      <div class="small_pfp">
        {% set other_user_id = conversation['first_user_id'] if g.user['id'] != conversation['first_user_id'] else conversation['second_user_id'] %}
        {% set other_username = conversation['first_user_username'] if g.user['id'] != conversation['first_user_id'] else conversation['second_user_username'] %}
        
        {% if has_pfp(other_user_id) %}
          <br>
          <a href="{{ url_for('user.nonuser_profile', username=other_username) }}">
            <img src="{{ url_for('user.crop_circle_50px', id=other_user_id) }}" alt="Profile Picture">
          </a>
        {% endif %}
        
        <h1>
          <a href="{{ url_for('user.nonuser_profile', username=other_username) }}" style="font-size: 18px; margin-left: 15px;">
            {{ other_username }}
          </a>
        </h1>
      </div>
      <header>
        <p>Last message: {{ conversation['last_message_content'] }}</p>
        <p>Time: {{ conversation['last_message_time'] }}</p>
        {% if conversation['last_sender_id'] == g.user['id'] %}
          {% if conversation['is_last_message_read'] %}
            <p>Status: Read</p>
          {% else %}
            <p>Status: Unread</p>
          {% endif %}
        {% endif %}
      </header>
    </article>
    {% if not loop.last %}
      <hr>
    {% endif %}
  {% endfor %}

  <article class="convo">
    <h2>Start a New Conversation</h2>
    <form action="{{ url_for('inbox.start_conversation') }}" method="post">
      <label for="recipient_username">Recipient's Username:</label>
      <input type="text" id="recipient_username" name="recipient_username" required>
      <button type="submit">Start Conversation</button>
    </form>
  </article>
{% endblock %}